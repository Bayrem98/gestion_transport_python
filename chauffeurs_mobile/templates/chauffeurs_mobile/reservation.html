<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation J+1</title>
    <style>
        /* Votre CSS original - inchang√© */
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
        }
        
        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        
        .filter-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            align-self: flex-end;
        }
        
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .agent-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        
        .agent-card:hover {
            transform: translateY(-2px);
        }
        
        .agent-card.reserved {
            border-color: #ff9800;
            background: #fff3e0;
        }
        
        .agent-card.mine {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        
        /* AM√âLIOR√â : Style pour la s√©lection */
        .agent-card.selected {
            border-color: #4361ee;
            border-width: 3px;
            background: #f0f4ff;
        }
        
        /* AM√âLIOR√â : Checkbox mieux positionn√©e */
        .selection-checkbox-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        
        .selection-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #4361ee;
            transform: scale(1.2);
        }
        
        /* Indicateur visuel pour la s√©lection */
        .selection-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 20px;
            height: 20px;
            background: #4361ee;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .agent-card.selected .selection-indicator {
            opacity: 1;
        }
        
        .agent-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            padding-right: 40px; /* Espace pour la checkbox */
        }
        
        .agent-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .agent-company {
            color: #667eea;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .agent-body {
            padding: 15px;
        }
        
        .agent-info {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .reservation-status {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-available {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #c8e6c9;
        }
        
        .status-reserved {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-mine {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b3e5fc;
        }
        
        .reservation-btn {
            width: 100%;
            padding: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .reservation-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .reservation-btn:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .reservations-list {
            margin-top: 30px;
        }
        
        .reservation-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 5px solid #667eea;
        }
        
        .btn-annuler {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .btn-annuler:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }
        
        .info-bulle {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }
        
        .stats-bar {
            display: flex;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            background: #e9ecef;
            margin: 10px 0;
        }
        
        .stats-disponible {
            background: #4caf50;
        }
        
        .stats-reserve {
            background: #ff9800;
        }
        
        .stats-text {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 10px;
        }
        
        /* AM√âLIOR√â : Panneau de s√©lection */
        .selection-panel {
            background: #f0f4ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #4361ee;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .selected-count {
            background: #4361ee;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .multi-reserve-btn {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .multi-reserve-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #45a049, #1b5e20);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        
        .multi-reserve-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .selected-agents-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
            max-height: 120px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .selected-agent-tag {
            background: white;
            border: 2px solid #4361ee;
            border-radius: 20px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .remove-selected {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .remove-selected:hover {
            background: #ff5252;
            transform: scale(1.1);
        }
        
        .clear-selection {
            background: #ff9800;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .clear-selection:hover {
            background: #e68900;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }
            
            .agents-grid {
                grid-template-columns: 1fr;
            }
            
            .selection-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .agent-header {
                padding-right: 15px;
            }
            
            .selection-checkbox-container {
                top: 8px;
                right: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="/mobile/dashboard/" class="back-btn">‚Üê Dashboard</a>
            <h2>R√©servation Agents (Demain)</h2>
            <div style="width: 100px;"></div>
        </div>
    </div>
    
    <div class="main-content">
        <!-- Filtres -->
        <div class="card">
            <div class="section-title">
                Crit√®res de recherche
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="filterType">Type de transport</label>
                    <select id="filterType">
                        <option value="ramassage">Ramassage</option>
                        <option value="depart">D√©part</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterHeure">Heure</label>
                    <select id="filterHeure">
                        <option value="">Choisir un type d'abord</option>
                    </select>
                </div>
                
                <button class="search-btn" onclick="loadAgentsDemain()">
                    Voir les agents
                </button>
            </div>
            
            <div id="dateInfo" style="text-align: center; margin-top: 15px; color: #666;">
                Chargement de la date...
            </div>
        </div>
        
        <!-- Panneau de s√©lection multiple -->
        <div id="selectionPanel" class="selection-panel">
            <div class="selection-header">
                <div>
                    <h3 style="margin: 0; color: #333; font-size: 18px;">S√©lection multiple</h3>
                    <div class="selected-count" id="selectedCount">0 s√©lectionn√©(s)</div>
                </div>
                <button class="clear-selection" onclick="clearSelection()">
                    ‚ùå Tout effacer
                </button>
            </div>
            
            <div id="selectedAgents" class="selected-agents-list">
                <!-- Les agents s√©lectionn√©s appara√Ætront ici -->
            </div>
            
            <button id="multiReserveBtn" class="multi-reserve-btn" onclick="reserverSelection()" disabled>
                üìÖ R√©server les agents s√©lectionn√©s
            </button>
        </div>
        
        <!-- Liste des agents disponibles -->
        <div class="card">
            <div class="section-title">
                Agents disponibles pour demain
                <span id="agentsCount" style="font-size: 14px; color: #666; margin-left: 10px;"></span>
            </div>
            
            <div id="agentsList">
                <div class="loading">
                    <p>S√©lectionnez un type et une heure pour voir les agents</p>
                </div>
            </div>
        </div>
        
        <!-- Mes r√©servations -->
        <div class="card">
            <div class="section-title">
                Mes r√©servations
            </div>
            
            <div id="myReservations">
                <div class="loading">
                    <p>Chargement de vos r√©servations...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // VOS VARIABLES ORIGINALES
    let currentType = 'ramassage';
    let currentHeureId = null;
    
    // AJOUT : Variables pour la s√©lection multiple
    let selectedAgents = new Set(); // Ensemble pour stocker les IDs s√©lectionn√©s
    let agentsData = {}; // Pour stocker les donn√©es des agents
    
    // Fonction pour r√©cup√©rer le token CSRF - ORIGINALE
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Charger les heures dynamiques selon le type - ORIGINALE
    async function loadHeuresByType() {
        const type = document.getElementById('filterType').value;
        const heureSelect = document.getElementById('filterHeure');
        
        heureSelect.innerHTML = '<option value="">Chargement...</option>';
        
        try {
            const response = await fetch('/mobile/api/reservations/demain/');
            const data = await response.json();
            
            if (data.success) {
                // Mettre √† jour la date
                document.getElementById('dateInfo').innerHTML = `
                    <strong>Date de r√©servation :</strong> ${data.date_demain_display} (Demain)
                `;
                
                // Remplir les heures selon le type
                const heures = type === 'ramassage' ? data.heures_ramassage : data.heures_depart;
                
                heureSelect.innerHTML = '<option value="">S√©lectionnez une heure</option>';
                heures.forEach(heure => {
                    heureSelect.innerHTML += `
                        <option value="${heure.id}">${heure.libelle}</option>
                    `;
                });
                
                currentType = type;
            }
        } catch (error) {
            console.error('Erreur:', error);
        }
    }
    
    // Charger les agents pour demain - ORIGINALE avec l√©g√®res modifications
    async function loadAgentsDemain() {
        const type = document.getElementById('filterType').value;
        const heureId = document.getElementById('filterHeure').value;
        
        if (!heureId) {
            alert('Veuillez s√©lectionner une heure');
            return;
        }
        
        currentHeureId = heureId;
        
        // AJOUT : R√©initialiser la s√©lection
        selectedAgents.clear();
        updateSelectionPanel();
        
        const agentsList = document.getElementById('agentsList');
        
        agentsList.innerHTML = `
            <div class="loading">
                <p>Recherche des agents pour demain...</p>
            </div>
        `;
        
        try {
            const response = await fetch(
                '/mobile/api/agents/disponibles/demain/?type_transport=' + type + '&heure_id=' + heureId
            );
            const data = await response.json();
            
            if (data.success) {
                // AJOUT : Stocker les donn√©es des agents
                agentsData = {};
                data.agents.forEach(agent => {
                    agentsData[agent.id] = agent;
                });
                
                displayAgentsDemain(data);
                loadMesReservations(); // Recharger aussi mes r√©servations
            } else {
                agentsList.innerHTML = `
                    <div class="error">
                        ${data.error}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erreur:', error);
            agentsList.innerHTML = `
                <div class="error">
                    Erreur de connexion au serveur
                </div>
            `;
        }
    }
    
    // Afficher les agents pour demain - MODIFI√âE pour ajouter la s√©lection
    function displayAgentsDemain(data) {
        const agentsList = document.getElementById('agentsList');
        
        if (!data.agents || data.agents.length === 0) {
            agentsList.innerHTML = `
                <div class="no-data">
                    <p>Aucun agent programm√© pour ces crit√®res</p>
                </div>
            `;
            return;
        }
        
        // Afficher les statistiques
        document.getElementById('agentsCount').innerHTML = `
            <span style="color: #4caf50;">${data.stats.total_disponibles} disponible(s)</span>
            <span style="margin: 0 10px; color: #ccc;">|</span>
            <span style="color: #ff9800;">${data.stats.total_reserves} r√©serv√©(s)</span>
            <span style="margin: 0 10px; color: #ccc;">|</span>
            <span style="color: #666;">${data.stats.total_agents} au total</span>
        `;
        
        let html = `
            <div style="margin-bottom: 20px;">
                <div class="stats-text">
                    üìä ${data.stats.disponibles_pourcent}% des agents sont disponibles
                </div>
                <div class="stats-bar">
                    <div class="stats-disponible" style="flex: ${data.stats.total_disponibles};"></div>
                    <div class="stats-reserve" style="flex: ${data.stats.total_reserves};"></div>
                </div>
            </div>
            <div class="agents-grid">
        `;
        
        data.agents.forEach(agent => {
            // D√©terminer la classe CSS selon le statut
            let cardClass = 'agent-card';
            let statusClass = 'status-available';
            let statusText = 'Disponible';
            let btnText = 'R√©server';
            let btnDisabled = false;
            let borderColor = '#4caf50';
            let isSelectable = false;
            
            if (agent.est_reserve) {
                if (agent.est_mien) {
                    cardClass += ' mine';
                    statusClass = 'status-mine';
                    statusText = '‚úì Votre r√©servation';
                    borderColor = '#4caf50';
                    btnText = '‚úì Votre agent';
                    btnDisabled = true;
                } else {
                    cardClass += ' reserved';
                    statusClass = 'status-reserved';
                    statusText = agent.chauffeur_reservant ? 
                        `‚úó R√©serv√© par ${agent.chauffeur_reservant}` : 
                        '‚úó D√©j√† r√©serv√©';
                    borderColor = '#ff9800';
                    btnText = 'Indisponible';
                    btnDisabled = true;
                }
            } else {
                isSelectable = true;
            }
            
            // AJOUT : V√©rifier si cet agent est s√©lectionn√©
            const isSelected = selectedAgents.has(agent.id);
            if (isSelected) {
                cardClass += ' selected';
            }
            
            html += `
                <div class="${cardClass}" 
                     style="border-color: ${borderColor};"
                     id="agent-card-${agent.id}"
                     onclick="handleCardClick(${agent.id}, event)">
                    
                    ${isSelectable ? `
                        <div class="selection-checkbox-container">
                            <input type="checkbox" 
                                   class="selection-checkbox"
                                   ${isSelected ? 'checked' : ''}
                                   id="checkbox-${agent.id}"
                                   onclick="event.stopPropagation(); toggleAgentSelection(${agent.id})">
                        </div>
                        <div class="selection-indicator">‚úì</div>
                    ` : ''}
                    
                    <div class="agent-header">
                        <div class="agent-name">${agent.nom}</div>
                        <div class="agent-company">${agent.societe}</div>
                    </div>
                    
                    <div class="agent-body">
                        <div class="agent-info">
                            <span>üìç</span> ${agent.adresse || 'Non sp√©cifi√©e'}
                        </div>
                        <div class="agent-info">
                            <span>üìû</span> ${agent.telephone || 'Non sp√©cifi√©'}
                        </div>
                        
                        <div class="reservation-status ${statusClass}">
                            ${statusText}
                        </div>
                        
                        <button class="reservation-btn" 
                                onclick="event.stopPropagation(); reserverAgent(${agent.id})"
                                ${btnDisabled ? 'disabled' : ''}
                                style="background: ${agent.est_reserve ? (agent.est_mien ? '#4caf50' : '#ff9800') : '#4caf50'};">
                            ${btnText}
                        </button>
                        
                        ${agent.est_reserve && !agent.est_mien ? `
                            <div class="info-bulle">
                                <strong>‚ÑπÔ∏è</strong> Cet agent a √©t√© r√©serv√© par un autre chauffeur
                            </div>
                        ` : ''}
                        
                        ${agent.est_mien && agent.reservation_id ? `
                            <button class="btn-annuler" 
                                    onclick="event.stopPropagation(); annulerReservationDirect(${agent.reservation_id})">
                                ‚ùå Annuler ma r√©servation
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        agentsList.innerHTML = html;
    }
    
    // AJOUT : G√©rer le clic sur la carte
    function handleCardClick(agentId, event) {
        // Ne pas d√©clencher si on clique sur un bouton ou un lien
        if (event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT') {
            return;
        }
        
        // V√©rifier si l'agent est s√©lectionnable
        const agent = agentsData[agentId];
        if (agent && !agent.est_reserve) {
            toggleAgentSelection(agentId);
        }
    }
    
    // AJOUT : Fonctions pour la s√©lection multiple
    function toggleAgentSelection(agentId) {
        const agent = agentsData[agentId];
        if (!agent || agent.est_reserve) return;
        
        const isCurrentlySelected = selectedAgents.has(agentId);
        const agentCard = document.getElementById(`agent-card-${agentId}`);
        const checkbox = document.getElementById(`checkbox-${agentId}`);
        
        if (isCurrentlySelected) {
            selectedAgents.delete(agentId);
            if (agentCard) agentCard.classList.remove('selected');
            if (checkbox) checkbox.checked = false;
        } else {
            selectedAgents.add(agentId);
            if (agentCard) agentCard.classList.add('selected');
            if (checkbox) checkbox.checked = true;
        }
        
        updateSelectionPanel();
    }
    
    function updateSelectionPanel() {
        const selectionPanel = document.getElementById('selectionPanel');
        const selectedCount = document.getElementById('selectedCount');
        const multiReserveBtn = document.getElementById('multiReserveBtn');
        const selectedAgentsDiv = document.getElementById('selectedAgents');
        
        const count = selectedAgents.size;
        
        if (count > 0) {
            selectionPanel.style.display = 'block';
            selectedCount.textContent = `${count} s√©lectionn√©(s)`;
            multiReserveBtn.textContent = `üìÖ R√©server les ${count} agents s√©lectionn√©s`;
            multiReserveBtn.disabled = false;
            
            // Afficher la liste des agents s√©lectionn√©s
            let html = '';
            selectedAgents.forEach(agentId => {
                const agent = agentsData[agentId];
                if (agent) {
                    html += `
                        <div class="selected-agent-tag">
                            <strong>${agent.nom}</strong>
                            <span>(${agent.societe})</span>
                            <button class="remove-selected" onclick="removeFromSelection(${agentId})">
                                √ó
                            </button>
                        </div>
                    `;
                }
            });
            selectedAgentsDiv.innerHTML = html;
        } else {
            selectionPanel.style.display = 'none';
            multiReserveBtn.disabled = true;
        }
    }
    
    function removeFromSelection(agentId) {
        selectedAgents.delete(agentId);
        
        // Mettre √† jour la checkbox
        const checkbox = document.getElementById(`checkbox-${agentId}`);
        if (checkbox) {
            checkbox.checked = false;
        }
        
        // Mettre √† jour la carte
        const agentCard = document.getElementById(`agent-card-${agentId}`);
        if (agentCard) {
            agentCard.classList.remove('selected');
        }
        
        updateSelectionPanel();
    }
    
    function clearSelection() {
        // D√©cocher toutes les checkboxes
        document.querySelectorAll('.selection-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Retirer la classe selected de toutes les cartes
        document.querySelectorAll('.agent-card.selected').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Vider la s√©lection
        selectedAgents.clear();
        updateSelectionPanel();
    }
    
    // AJOUT : R√©server la s√©lection
    async function reserverSelection() {
        if (selectedAgents.size === 0) {
            alert('Veuillez s√©lectionner au moins un agent');
            return;
        }
        
        if (!confirm(`Confirmer la r√©servation de ${selectedAgents.size} agent(s) pour demain ?`)) {
            return;
        }
        
        const notes = prompt('Notes communes pour toutes les r√©servations (optionnel) :', '');
        
        // Pour chaque agent s√©lectionn√©, faire une requ√™te
        let successCount = 0;
        const agentIds = Array.from(selectedAgents);
        
        for (const agentId of agentIds) {
            try {
                const response = await fetch('/mobile/api/reservations/reserver/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        agent_id: agentId,
                        type_transport: currentType,
                        heure_id: currentHeureId,
                        notes: notes || ''
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    successCount++;
                }
            } catch (error) {
                console.error(`Erreur pour l'agent ${agentId}:`, error);
            }
        }
        
        alert(`‚úÖ ${successCount} r√©servation(s) effectu√©e(s) avec succ√®s sur ${selectedAgents.size}`);
        
        // Recharger les donn√©es
        loadAgentsDemain();
        loadMesReservations();
        clearSelection();
    }
    
    // R√©server un agent - ORIGINALE
    async function reserverAgent(agentId) {
        if (!confirm('Confirmer la r√©servation de cet agent pour demain ?')) {
            return;
        }
        
        const notes = prompt('Notes (optionnel) :', '');
        
        try {
            const response = await fetch('/mobile/api/reservations/reserver/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    agent_id: agentId,
                    type_transport: currentType,
                    heure_id: currentHeureId,
                    notes: notes || ''
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(data.message);
                loadAgentsDemain(); // Recharger la liste
                loadMesReservations(); // Recharger mes r√©servations
            } else {
                if (data.chauffeur_reservant) {
                    alert(data.error + '\n\nContactez le chauffeur : ' + data.chauffeur_reservant);
                } else {
                    alert(data.error);
                }
            }
        } catch (error) {
            alert('Erreur de connexion');
        }
    }
    
    // Annuler une r√©servation directement depuis la liste des agents - ORIGINALE
    async function annulerReservationDirect(reservationId) {
        if (!confirm('√ätes-vous s√ªr de vouloir annuler cette r√©servation ?')) {
            return;
        }
        
        try {
            const response = await fetch('/mobile/api/reservations/annuler/' + reservationId + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('‚úÖ R√©servation annul√©e avec succ√®s');
                // Recharger la liste des agents
                loadAgentsDemain();
                // Recharger mes r√©servations
                loadMesReservations();
            } else {
                alert('‚ùå ' + data.error);
            }
        } catch (error) {
            alert('Erreur de connexion au serveur');
        }
    }
    
    // Annuler une r√©servation depuis la liste "Mes r√©servations" - ORIGINALE
    async function annulerReservation(reservationId) {
        if (!confirm('√ätes-vous s√ªr de vouloir annuler cette r√©servation ?')) {
            return;
        }
        
        try {
            const response = await fetch('/mobile/api/reservations/annuler/' + reservationId + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('‚úÖ R√©servation annul√©e avec succ√®s');
                // Recharger la liste des agents
                loadAgentsDemain();
                // Recharger mes r√©servations
                loadMesReservations();
            } else {
                alert('‚ùå ' + data.error);
            }
       } catch (error) {
            alert('Erreur de connexion au serveur');
        }
    }
    
    // Charger mes r√©servations - ORIGINALE
    async function loadMesReservations() {
        try {
            const response = await fetch('/mobile/api/reservations/mes-reservations/');
            const data = await response.json();
            
            if (data.success) {
                displayMesReservations(data);
            }
        } catch (error) {
            console.error('Erreur:', error);
        }
    }
    
    // Afficher mes r√©servations - ORIGINALE
    function displayMesReservations(data) {
        const container = document.getElementById('myReservations');
        
        if (data.reservations.length === 0) {
            container.innerHTML = `
                <div class="no-data">
                    <p>Vous n'avez aucune r√©servation</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div style="margin-bottom: 15px; color: #666;">
                ${data.total} r√©servation(s) total - 
                ${data.reservations_demain} pour demain
            </div>
            <div class="reservations-list">
        `;
        
        data.reservations.forEach(reservation => {
            html += `
                <div class="reservation-item">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">
                                ${reservation.agent.nom}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ${reservation.date_display} - ${reservation.heure.libelle}
                                (${reservation.type_display})
                            </div>
                            <div style="color: #888; font-size: 12px; margin-top: 5px;">
                                üìç ${reservation.agent.adresse || 'Non sp√©cifi√©e'}
                            </div>
                            ${reservation.notes ? `
                                <div style="color: #666; font-size: 13px; margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 5px;">
                                    <strong>Notes :</strong> ${reservation.notes}
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right;">
                            <span style="display: inline-block; padding: 5px 10px; background: ${reservation.statut === 'reservee' ? '#fff3cd' : '#e8f5e9'}; color: ${reservation.statut === 'reservee' ? '#856404' : '#388e3c'}; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                ${reservation.statut_display}
                            </span>
                            ${reservation.peut_annuler ? `
                                <button onclick="annulerReservation(${reservation.id})" style="margin-top: 10px; padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    Annuler
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Initialisation - ORIGINALE
    document.addEventListener('DOMContentLoaded', function() {
        // Charger les heures au changement du type
        document.getElementById('filterType').addEventListener('change', loadHeuresByType);
        
        // Charger les heures initiales
        loadHeuresByType();
        
        // Charger mes r√©servations
        loadMesReservations();
        
        console.log('Syst√®me de r√©servation initialis√©');
    });
    </script>
</body>
</html>
{% extends 'gestion/base.html' %}

{% block page_title %}Gestion des Agents{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== BARRE DE RECHERCHE ==========
    const rechercheInput = document.getElementById('recherche-agent');
    const agentsTable = document.querySelector('table');
    
    if (rechercheInput && agentsTable) {
        rechercheInput.addEventListener('input', function() {
            const terme = this.value.toLowerCase();
            const lignes = agentsTable.querySelectorAll('tbody tr');
            let compteur = 0;
            
            lignes.forEach(ligne => {
                const texteLigne = ligne.textContent.toLowerCase();
                if (texteLigne.includes(terme)) {
                    ligne.style.display = '';
                    compteur++;
                } else {
                    ligne.style.display = 'none';
                }
            });
            
            // Mettre √† jour le compteur
            document.getElementById('compteur-agents').textContent = compteur;
        });
    }
    
    // ========== GESTION DU CHAMP SOCI√âT√â ==========
    const societeSelect = document.getElementById('id_societe_select');
    const societeTexte = document.getElementById('id_societe_texte');
    
    if (societeSelect && societeTexte) {
        // Synchroniser les champs soci√©t√©
        societeSelect.addEventListener('change', function() {
            if (this.value) {
                societeTexte.disabled = true;
                societeTexte.value = '';
            } else {
                societeTexte.disabled = false;
            }
        });
        
        societeTexte.addEventListener('input', function() {
            if (this.value.trim()) {
                societeSelect.value = '';
            }
        });
    }
    
    // ========== TOGGLE TOUT COCHER/D√âCOCHER ==========
    const toggleToutCocher = document.getElementById('toggle-tout-cocher');
    if (toggleToutCocher) {
        toggleToutCocher.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.agent-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = this.checked;
                }
            });
        });
    }
    
    // ========== ACTION MULTIPLE ==========
    const actionMultipleSelect = document.getElementById('action-multiple');
    const executerActionBtn = document.getElementById('executer-action');
    
    if (executerActionBtn) {
        executerActionBtn.addEventListener('click', function() {
            const action = actionMultipleSelect.value;
            const checkboxes = document.querySelectorAll('.agent-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            
            if (ids.length === 0) {
                alert('Veuillez s√©lectionner au moins un agent');
                return;
            }
            
            if (action === 'supprimer_multiple') {
                if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${ids.length} agent(s) ?`)) {
                    supprimerAgentsMultiple(ids);
                }
            } else {
                alert('Veuillez s√©lectionner une action');
            }
        });
    }
    
    // ========== AJAX POUR CHARGER LES SOCI√âT√âS ==========
    chargerSocietes();
});

// Fonction pour charger les soci√©t√©s
function chargerSocietes() {
    fetch('/societes/api/liste/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('id_societe_select');
            if (select) {
                select.innerHTML = '<option value="">S√©lectionner une soci√©t√© existante</option>';
                data.forEach(societe => {
                    const option = document.createElement('option');
                    option.value = societe.id;
                    option.textContent = societe.nom;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Erreur:', error));
}

// Fonction pour supprimer plusieurs agents
function supprimerAgentsMultiple(ids) {
    fetch('/agents/supprimer_multiple/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ agent_ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.deleted} agent(s) supprim√©(s) avec succ√®s`);
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    });
}

// Fonction pour ajouter rapidement une soci√©t√©
function ajouterSocieteRapide() {
    const nomSociete = prompt('Entrez le nom de la nouvelle soci√©t√©:');
    if (nomSociete && nomSociete.trim()) {
        fetch('/societes/api/ajouter_rapide/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ nom: nomSociete.trim() })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Soci√©t√© ajout√©e avec succ√®s!');
                // Mettre √† jour la liste des soci√©t√©s
                chargerSocietes();
                // S√©lectionner la nouvelle soci√©t√©
                setTimeout(() => {
                    const select = document.getElementById('id_societe_select');
                    if (select) {
                        const nouvelleOption = Array.from(select.options).find(opt => opt.text === nomSociete.trim());
                        if (nouvelleOption) {
                            select.value = nouvelleOption.value;
                            document.getElementById('id_societe_texte').disabled = true;
                        }
                    }
                }, 500);
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue');
        });
    }
}
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-user-tie"></i> Gestion des Agents</h5>
                <div>
                    <a href="{% url 'importer_agents' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-file-import"></i> Importer Excel
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Alerte agents incomplets -->
                {% if agents_incomplets > 0 %}
                <div class="alert alert-warning mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Agents avec informations incompl√®tes</h6>
                            <p class="mb-0">
                                <strong>{{ agents_incomplets }}</strong> agent(s) sur {{ total_agents }} ont des informations manquantes.
                                <a href="?filtre=incomplets" class="alert-link">Voir et compl√©ter maintenant</a>
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Filtres et statistiques -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="btn-group" role="group">
                            <a href="?filtre=tous" class="btn btn-outline-primary {% if filtre_actuel == 'tous' %}active{% endif %}">
                                Tous ({{ total_agents }})
                            </a>
                            <a href="?filtre=complets" class="btn btn-outline-success {% if filtre_actuel == 'complets' %}active{% endif %}">
                                Complets ({{ agents_complets }})
                            </a>
                            <a href="?filtre=incomplets" class="btn btn-outline-warning {% if filtre_actuel == 'incomplets' %}active{% endif %}">
                                Incomplets ({{ agents_incomplets }})
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                {{ agents_complets }} complets / {{ agents_incomplets }} incomplets
                            </small>
                        </div>
                    </div>
                </div>

                <!-- BARRE DE RECHERCHE ET ACTIONS MULTIPLES -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="recherche-agent" class="form-control" 
                                   placeholder="Rechercher un agent par nom, t√©l√©phone, soci√©t√©...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <select id="action-multiple" class="form-select">
                                <option value="">Action multiple...</option>
                                <option value="supprimer_multiple">Supprimer les agents s√©lectionn√©s</option>
                            </select>
                            <button id="executer-action" class="btn btn-danger" type="button">
                                <i class="fas fa-play"></i> Ex√©cuter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Formulaire d'ajout d'agent -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0"><i class="fas fa-user-plus"></i> Ajouter un Nouvel Agent</h6>
                                <button type="button" class="btn btn-sm btn-info" onclick="ajouterSocieteRapide()">
                                    <i class="fas fa-plus"></i> Ajouter une soci√©t√© rapide
                                </button>
                            </div>
                            <div class="card-body">
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Nom complet *</label>
                                                {{ form.nom }}
                                                {% if form.nom.errors %}
                                                <div class="text-danger">{{ form.nom.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">T√©l√©phone *</label>
                                                {{ form.telephone }}
                                                {% if form.telephone.errors %}
                                                <div class="text-danger">{{ form.telephone.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Soci√©t√© *</label>
                                                <div class="mb-2">
                                                    <select id="id_societe_select" name="societe_select" class="form-control">
                                                        <option value="">S√©lectionner une soci√©t√© existante</option>
                                                        {% for societe in societes_list %}
                                                        <option value="{{ societe.id }}">{{ societe.nom }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">Ou cr√©er</span>
                                                    <input type="text" id="id_societe_texte" name="societe_texte" 
                                                           class="form-control" placeholder="Nouvelle soci√©t√©">
                                                </div>
                                                {% if form.societe_select.errors or form.societe_texte.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.societe_select.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                    {% for error in form.societe_texte.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Adresse *</label>
                                                {{ form.adresse }}
                                                {% if form.adresse.errors %}
                                                <div class="text-danger">{{ form.adresse.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="form-check form-switch mt-4">
                                                    {{ form.voiture_personnelle }}
                                                    <label class="form-check-label fw-bold" for="{{ form.voiture_personnelle.id_for_label }}">
                                                        Voiture personnelle
                                                    </label>
                                                </div>
                                                <small class="form-text text-muted">
                                                    Si activ√©, l'agent sera exclu des transports
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Ajouter l'Agent
                                        </button>
                                        <button type="reset" class="btn btn-secondary">
                                            <i class="fas fa-undo"></i> R√©initialiser
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des agents -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-list"></i> Liste des Agents 
                                    (<span id="compteur-agents">{{ agents|length }}</span>)
                                    {% if filtre_actuel == 'complets' %}
                                        <span class="badge bg-success">Complets seulement</span>
                                    {% elif filtre_actuel == 'incomplets' %}
                                        <span class="badge bg-warning">Incomplets seulement</span>
                                    {% endif %}
                                </h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="toggle-tout-cocher">
                                    <label class="form-check-label" for="toggle-tout-cocher">
                                        Tout cocher
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if agents %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th width="50">
                                                        #
                                                    </th>
                                                    <th>Nom</th>
                                                    <th>Soci√©t√©</th>
                                                    <th>T√©l√©phone</th>
                                                    <th>Adresse</th>
                                                    <th>Voiture</th>
                                                    <th>Statut</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for agent in agents %}
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" class="form-check-input agent-checkbox" 
                                                               value="{{ agent.id }}">
                                                    </td>
                                                    <td>
                                                        <strong>{{ agent.nom }}</strong>
                                                        <br>
                                                        <small class="text-muted">Cr√©√© le: {{ agent.created_at|date:"d/m/Y" }}</small>
                                                    </td>
                                                    <td>
                                                        {% if agent.societe %}
                                                            <span class="badge bg-info">{{ agent.societe.nom }}</span>
                                                        {% elif agent.societe_texte %}
                                                            <span class="badge bg-secondary">{{ agent.societe_texte }}</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">Non sp√©cifi√©</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ agent.telephone }}</td>
                                                    <td>
                                                        <small>{{ agent.adresse|truncatewords:5 }}</small>
                                                    </td>
                                                    <td>
                                                        {% if agent.voiture_personnelle %}
                                                            <span class="badge bg-success">Oui</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">Non</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if agent.est_complet %}
                                                            <span class="badge bg-success">Complet</span>
                                                        {% else %}
                                                            <span class="badge bg-warning">Incomplet</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'modifier_agent' agent.id %}" class="btn btn-warning">
                                                                <i class="fas fa-edit"></i> Modifier
                                                            </a>
                                                            <a href="{% url 'detail_agent' agent.id %}" class="btn btn-info">
                                                                <i class="fas fa-eye"></i> D√©tails
                                                            </a>
                                                            <a href="{% url 'supprimer_agent' agent.id %}" class="btn btn-danger" 
                                                               onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer l\'agent {{ agent.nom }} ?')">
                                                                <i class="fas fa-trash"></i> Supprimer
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-user-tie fa-3x mb-3"></i>
                                            <h5>Aucun agent trouv√©</h5>
                                            <p>
                                                {% if filtre_actuel == 'complets' %}
                                                    Aucun agent avec des informations compl√®tes.
                                                {% elif filtre_actuel == 'incomplets' %}
                                                    Tous les agents ont des informations compl√®tes ! üéâ
                                                {% else %}
                                                    Ajoutez votre premier agent en utilisant le formulaire ci-dessus.
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles pour la barre de recherche */
#recherche-agent:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    transition: all 0.3s ease;
}

/* Styles pour les checkboxes */
.agent-checkbox {
    transform: scale(1.2);
    cursor: pointer;
}

.agent-checkbox:checked {
    background-color: #007bff;
    border-color: #007bff;
}

/* Styles pour les badges */
.badge.bg-info {
    background: linear-gradient(135deg, #17a2b8, #138496) !important;
    color: white !important;
    font-weight: 600;
}

.badge.bg-secondary {
    background: linear-gradient(135deg, #6c757d, #545b62) !important;
    color: white !important;
    font-weight: 600;
}

.badge.bg-danger {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    color: white !important;
    font-weight: 600;
}

.badge.bg-success {
    background: linear-gradient(135deg, #28a745, #218838) !important;
    color: white !important;
    font-weight: 600;
}

.badge.bg-warning {
    background: linear-gradient(135deg, #ffc107, #e0a800) !important;
    color: #000 !important;
    font-weight: 600;
}

/* Animation pour la recherche */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Styles pour le formulaire soci√©t√© */
.input-group-text {
    font-weight: 600;
    background: linear-gradient(135deg, #e9ecef, #dee2e6);
    border-color: #ced4da;
}

/* Bouton ajouter soci√©t√© rapide */
.btn-sm.btn-info {
    background: linear-gradient(135deg, #17a2b8, #138496);
    border: none;
    color: white;
    font-weight: 600;
}

.btn-sm.btn-info:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}
